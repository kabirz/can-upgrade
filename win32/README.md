# CAN固件升级工具

纯 Win32 API 实现的 CAN 固件升级工具，支持通过 PCAN 适配器更新设备固件。

## 功能特性

- **CAN连接管理**
  - 固定支持 PCAN USB 适配器（USB0-USB3）
  - 8种波特率选择：10K, 20K, 50K, 83K, 125K, 250K, 500K, 1000K
  - 实时连接状态显示

- **固件升级**
  - 文件选择对话框
  - 实时进度条显示
  - 测试模式支持（第二次重启后恢复原固件）
  - 升级过程日志记录

- **板卡命令**
  - 获取固件版本
  - 重启板卡

- **日志系统**
  - 实时日志显示（微软雅黑）
  - 状态/错误消息分类显示

## 界面预览

窗口大小：740×600（随系统 DPI 自动缩放）

```
┌─────────────────────────────────────────────────────────────┐
│                    CAN固件升级工具                           │
├─────────────────────────────────────────────────────────────┤
│ 【连接设置】                                                 │
│ 设备: [USB0▼]  波特率: [250K▼]  [刷新设备列表]  [连接]      │
├─────────────────────────────────────────────────────────────┤
│ 【固件升级】                                                 │
│ 固件文件: [____________________] [浏览...]                  │
│ ☑ 测试模式(第二次重启后恢复原固件)                          │
│ 进度: [████████░░░░░░░░░] 50%                               │
│                                    [开始升级]                │
├─────────────────────────────────────────────────────────────┤
│ 【板卡命令】                                                 │
│ 固件版本: [未连接]         [获取版本]  [重启板卡]            │
├─────────────────────────────────────────────────────────────┤
│ 【状态日志】                                                 │
│ ┌─────────────────────────────────────────────────────────┐ │
│ │ CAN固件升级工具已启动                                   │ │
│ │ 请选择CAN设备和波特率，然后点击连接                     │ │
│ │ Connected to pcan:usb0, baudrate 250000                │ │
│ │ Starting firmware upgrade, size: 65536 bytes           │ │
│ │ File firmware.bin upload complete...                   │ │
│ └─────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

## 编译环境

- **推荐**: Ubuntu Linux + MinGW-w64 交叉编译
- **可选**: Windows + MinGW-w64 原生编译

## 编译步骤

### 1. 安装 MinGW-w64 (Ubuntu)

```bash
sudo apt install mingw-w64
```

### 2. 配置 PCAN-Basic SDK

将 SDK 文件放置在项目根目录：

```
/
├── Include/
│   └── PCANBasic.h
└── libs/
    └── x64/
        └── PCANBasic.dll
```

### 3. 编译

```bash
cmake --workflow release
```

编译输出：`build/can-upgrade.exe`

## 文件结构

```
src/
├── main.cpp          # 主程序和 Win32 GUI 界面
├── can_manager.cpp   # CAN 通信管理器实现
├── can_manager.h     # CAN 管理器接口
├── can_protocol.h    # CAN 协议定义
└── resource.h        # 资源 ID 定义

resources/
└── resource.rc       # Windows 资源脚本

CMakeLists.txt        # CMake 构建配置
```

## CAN 协议

### CAN ID 定义

| CAN ID | 名称 | 方向 | 描述 |
|--------|------|------|------|
| 0x101 | PLATFORM_RX | PC → 板卡 | 发送到板卡的命令帧 |
| 0x102 | PLATFORM_TX | 板卡 → PC | 板卡响应帧 |
| 0x103 | FW_DATA_RX | PC → 板卡 | 固件数据帧 |

### 命令代码

| 命令 | 值 | 描述 |
|------|-----|------|
| BOARD_START_UPDATE | 0 | 初始化固件更新 |
| BOARD_CONFIRM | 1 | 确认并应用固件 |
| BOARD_VERSION | 2 | 请求固件版本 |
| BOARD_REBOOT | 3 | 重启板卡 |

### 响应代码

| 响应 | 值 | 描述 |
|------|-----|------|
| FW_CODE_OFFSET | 0 | 数据偏移确认 |
| FW_CODE_UPDATE_SUCCESS | 1 | 更新成功 |
| FW_CODE_VERSION | 2 | 版本响应 |
| FW_CODE_CONFIRM | 3 | 确认响应 |
| FW_CODE_FLASH_ERROR | 4 | Flash 操作错误 |
| FW_CODE_TRANFER_ERROR | 5 | 数据传输错误 |

## 运行要求

- Windows 7 或更高版本
- PCAN-USB 驱动程序
- PCAN 适配器硬件
- PCANBasic.dll（需与可执行文件放在一起）

## 技术特点

- **纯 Win32 API** - 无第三方 GUI 框架依赖
- **Unicode 支持** - 完整中文界面
- **DPI 感知** - 自动适应高 DPI 显示器，字体清晰锐利
- **静态链接** - C++ 运行时静态链接，无需额外 DLL
- **交叉编译** - 支持 Linux 下编译 Windows 程序
- **代码简洁** - 直接调用 Win32 API，无冗余抽象层
- **紧凑体积** - 可执行文件约 440 KB

## 代码统计

| 文件 | 行数 | 说明 |
|------|------|------|
| main.cpp | 430 | 主程序和 GUI |
| can_manager.cpp | 372 | CAN 通信管理 |
| can_manager.h | 57 | CAN 管理器接口 |
| can_protocol.h | 59 | CAN 协议定义 |
| **总计** | **918** | **核心代码** |

## 许可证

本项目基于 MIT 许可证开源。

PCAN-Basic SDK 属于 PEAK-System GmbH，需遵循其许可协议。
